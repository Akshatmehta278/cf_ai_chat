<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare AI Chat Assistant</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app">
        <header>
            <h1>AI Chat Assistant</h1>
            <p>Powered by Cloudflare Workers AI + Llama 3.3</p>
        </header>

        <main id="chat">
            <!-- Messages will appear here -->
            <div class="message system">
                ðŸ¤– Welcome! This AI assistant is powered by Cloudflare's Workers AI.
                <br>
                Ask me anything - I'm here to help!
            </div>
        </main>

        <footer>
            <input 
                type="text" 
                id="input" 
                placeholder="Type your message here..."
                autocomplete="off"
                autofocus
            >
            <button id="send">
                Send
            </button>
        </footer>
    </div>

    <script>
        // DOM elements
        const chat = document.getElementById("chat");
        const input = document.getElementById("input");
        const sendBtn = document.getElementById("send");
        
        // Generate a session ID
        const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        let conversationHistory = [];

        // Function to add a message to the chat
        function addMessage(role, text) {
            const div = document.createElement("div");
            div.className = `message ${role}`;
            div.textContent = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            
            // Add to conversation history
            conversationHistory.push({ role, content: text });
        }

        // Function to show typing indicator
        function showTyping() {
            const loader = document.createElement("div");
            loader.className = "message system";
            loader.id = "typing-indicator";
            loader.textContent = "AI is thinking...";
            chat.appendChild(loader);
            chat.scrollTop = chat.scrollHeight;
        }

        // Function to hide typing indicator
        function hideTyping() {
            const loader = document.getElementById("typing-indicator");
            if (loader) loader.remove();
        }

        // Main send function
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // Clear input
            input.value = "";
            
            // Add user message
            addMessage("user", text);
            
            // Show typing indicator
            showTyping();
            
            // Disable send button while processing
            sendBtn.disabled = true;
            input.disabled = true;

            try {
                // Prepare request data
                const requestData = {
                    message: text,
                    sessionId: sessionId,
                    conversationHistory: conversationHistory.slice(0, -1) // Exclude the message we just added
                };

                // Send to API
                const res = await fetch("/api/chat", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(requestData)
                });

                // Hide typing indicator
                hideTyping();

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    addMessage("assistant", `âŒ Error: ${errorData.error || `Server error (${res.status})`}`);
                    return;
                }

                const data = await res.json();
                
                if (data.success && data.message && data.message.content) {
                    addMessage("assistant", data.message.content);
                } else {
                    addMessage("assistant", "âŒ No response received from server");
                }

            } catch (err) {
                hideTyping();
                console.error("Network error:", err);
                addMessage("assistant", "âŒ Network error - please check your connection");
            } finally {
                // Re-enable input
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // Event listeners
        sendBtn.onclick = sendMessage;
        
        input.onkeydown = (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // Load conversation history on page load
        async function loadHistory() {
            try {
                const res = await fetch(`/api/history?sessionId=${sessionId}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.messages && data.messages.length > 0) {
                        // Clear initial welcome message
                        const systemMsg = document.querySelector('.message.system');
                        if (systemMsg) systemMsg.remove();
                        
                        // Load previous messages
                        data.messages.forEach(msg => {
                            addMessage(msg.role, msg.content);
                        });
                    }
                }
            } catch (error) {
                console.error("Failed to load history:", error);
            }
        }

        // Load history when page loads
        loadHistory();

        // Focus input on load
        input.focus();
    </script>
</body>
</html>